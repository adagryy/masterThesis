
@model serwer.Models.ImagesDownloadDetails

@{
    ViewBag.Title = "ImagesView";
    Layout = "~/Views/Shared/_Layout.cshtml";

}

@{
    <br />
    <div class="container-fluid">
        <div class="row">
            <br /><br />
            <div class="col-sm-8">
                @Html.ActionLink("Ponownie ładuj obraz", "uploadFile", "Images", null, new { @class = "btn btn-primary btn-lg" })
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            @{
                if (ViewBag.Message != null)
                {
                    <div class="alert alert-success">
                        <p>@ViewBag.Message</p>
                    </div>
                }
            }
        </div>
    </div>

    foreach (string file in Model.items)
    {
        <div class="container-fluid">
            <div>
                @{
                    string imPath = "";
                    if (file.Equals(serwer.Config.ServerConfigurator.originalImageName + Model.originalImageExtension))
                    {
                        <p>
                            <h2>Obraz orginalny</h2>
                            @*@Html.ActionLink("Pobierz", "Download", "Images", new { ImageName = "images.jpg" }) this syntax not working, so be cerreful*@
                            
                            
                            @using (@Html.BeginForm("RemoveImage", "Images", FormMethod.Post, new { @class = "", role = "form", enctype = "multipart/form-data" }))
                            {
                                @Html.AntiForgeryToken()
                                Model.removeImagePath = serwer.Config.ServerConfigurator.imageStoragePath + User.Identity.Name + "/" + file.ToString();    
                                            
                                @Html.HiddenFor(r => r.removeImagePath)

                                @Html.ActionLink("Pobierz obraz", "Download", "Images", routeValues: new { ImageName = @file.ToString() }, htmlAttributes: new { @class = "btn btn-success btn-lg" })
                                <input type="submit" value="Usuń" class="btn btn-danger btn-lg" />                                           
                            }          
                             
                            </p>

                        imPath = Url.Content(serwer.Config.ServerConfigurator.imageStoragePath + User.Identity.Name + "/" + file) + "?noCache=" + DateTimeOffset.Now.ToUnixTimeMilliseconds();
                        <p>
                            <center>
                                <div class="row">
                                    <img class="img-responsive" src="@imPath" />

                                </div>
                            </center>
                        </p>
                        
                        
                        if (!File.Exists(Server.MapPath(serwer.Config.ServerConfigurator.imageStoragePath + User.Identity.Name + "/" + serwer.Config.ServerConfigurator.processedImageName + Model.processedImageExtension)))
                        {
                            <br />
                            <p><h4> Trwa przetwarzanie obrazu. Strona odświeży się automatycznie, gdy przetwarzanie zostanie zakończone.</h4></p>
                        }

                    }
                    else if (file.Equals(serwer.Config.ServerConfigurator.processedImageName + Model.processedImageExtension))
                    {
                        <p>
                            <h2>Obraz przetworzony</h2>
                            @*@Html.ActionLink("Pobierz", "Download", "Images", new { ImageName = "images.jpg" }) this syntax not working, so be cerreful*@
                            
                            @using (@Html.BeginForm("RemoveImage", "Images", FormMethod.Post, new { @class = "", role = "form", enctype = "multipart/form-data" }))
                            {
                                @Html.AntiForgeryToken()
                                Model.removeImagePath = serwer.Config.ServerConfigurator.imageStoragePath + User.Identity.Name + "/" + file.ToString();

                                @Html.HiddenFor(r => r.removeImagePath)

                                @Html.ActionLink("Pobierz obraz", "Download", "Images", routeValues: new { ImageName = @file.ToString() }, htmlAttributes: new { @class = "btn btn-success btn-lg" })
                                <input type="submit" value="Usuń" class="btn btn-danger btn-lg" />
                            }    
                        </p>
                        imPath = Url.Content(serwer.Config.ServerConfigurator.imageStoragePath + User.Identity.Name + "/" + file) + "?noCache=" + DateTimeOffset.Now.ToUnixTimeMilliseconds();
                        <div class="row">
                            <img class="img-responsive" id="processedImage" src="@imPath" />
                        </div>
                    }
                    else if (file.Equals(serwer.Config.ServerConfigurator.afterProcessingDataFileName + serwer.Config.ServerConfigurator.afterProcessingDataFileExtension) && Model.processedImageDataInJSON != null)
                    {
                        <p>
                            <h2>Dane z przetworzonego obrazu</h2>

                            @{
                                // Below it displays whole content of JSON file
                                dynamic stuff = Newtonsoft.Json.JsonConvert.DeserializeObject(Model.processedImageDataInJSON);
                                foreach (var stuffItem in stuff)
                                {
                                    <div><strong>@stuffItem.Name: </strong>@stuffItem.Value</div>
                                }
                            }
                            <br />
                            @Html.ActionLink("Pobierz dane", "Download", "Images", routeValues: new { ImageName = @file.ToString() }, htmlAttributes: new { @class = "btn btn-success btn-lg" })
                        </p>
                    }
                    else
                    {
                        // DateTimeOffset.Now.ToUnixTimeMilliseconds() is used to prevent caching images in browsers
                        // this "imPath" - path to the personal original image
                        imPath = Url.Content(serwer.Config.ServerConfigurator.imageStoragePath + User.Identity.Name + "/" + file) + "?noCache=" + DateTimeOffset.Now.ToUnixTimeMilliseconds();
                        <div class="row" id="processedImage">
                            <img class="img-responsive" src="@imPath" />
                        </div>
                    }

                }
            </div>
            @*<div class="row">
                <img class="img-responsive col-sm-8" src="@imPath" />
            </div>*@
        </div>
    }

    
    <script type="text/javascript">
        var protocol = window.location.protocol;
        var domain = window.location.hostname;
        var port = window.location.port;

        var url = protocol + "//" + domain + ":" + port + "/MobileDevices/checkIfProcessingIsFinished";

        // Shorthand for $( document ).ready()
        $(function () {
            $.ajax({
                url: url,
                method: "POST",
                statusCode: {
                    404: function () {
                        setTimeout(checkIfProcessingIsFinished, 2000); // you could choose not to continue on failure...
                    },
                    200: function () {
                        if ($("#processedImage").length === 0) {
                            location.reload();
                        }
                        console.log("OK");
                    }
                }
            });
        });

        function checkIfProcessingIsFinished() {
            $.ajax({
                url: url,
                method: "POST",
                statusCode: {
                    404: function () {
                        console.log("page not found");
                        setTimeout(checkIfProcessingIsFinished, 2000); // you could choose not to continue on failure...
                    },
                    200: function () {
                        location.reload();
                        console.log("OK");
                    }
                }
            });
        }
    </script>
    
}
